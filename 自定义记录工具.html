<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <title>ËÆ∞ÂΩïÂ∑•ÂÖ∑</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css"/>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuedraggable@2.24.3/dist/vuedraggable.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css">

    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        #app {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            padding: 10px;
            border-right: 1px solid #dcdfe6;
            overflow-y: auto;
            background: #f5f7fa;
        }

        .main {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .remark-input {
            width: 100%;
        }

        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 10px;
        }

        .el-button + .el-button,
        .el-checkbox.is-bordered + .el-checkbox.is-bordered {
            margin: 0;
        }
    </style>
</head>
<body>
<div id="app">
    <!-- Sidebar -->
    <div class="sidebar">
        <h3>üìú ÂéÜÂè≤ËÆ∞ÂΩï</h3>
        <div class="button-grid">
            <el-button size="mini" type="info" size="mini" @click="createGroup">‚ûïÊñ∞Âª∫ÂàÜÁªÑ</el-button>
            <el-button type="default" size="mini" @click="drawerVisible = true" size="mini">üìä AIÂàÜÊûê</el-button>
            <el-button icon="el-icon-download" @click="exportData" size="mini" plain>ÂØºÂá∫Â§á‰ªΩ</el-button>
            <el-button type="default" icon="el-icon-upload" size="mini" @click="$refs.fileInput.click()">ÂØºÂÖ•ÊÅ¢Â§ç</el-button>
            <input type="file" ref="fileInput" style="display: none" @change="importData" />
            <el-button type="danger" icon="el-icon-delete" @click="clearHistory" size="mini" plain>Ê∏ÖÁ©∫</el-button>
        </div>
        <el-divider></el-divider>

        <!-- ÊõøÊç¢ËøôÊÆµ sidebar ‰∏≠ÂéÜÂè≤ËÆ∞ÂΩïÁöÑÂ±ïÁ§∫ÈÉ®ÂàÜ -->
        <!--        <div v-for="(item, index) in history" :key="index"-->
        <!--             style="display: flex; justify-content: space-between; align-items: center;">-->
        <!--            <div @click="loadHistory(index)" style="cursor: pointer; flex: 1;">-->
        <!--                [{{ index + 1 }}] {{ item.remark }}-->
        <!--            </div>-->
        <!--            <el-button icon="el-icon-delete" size="mini" type="text" @click.stop="deleteHistory(index)"></el-button>-->
        <!--        </div>-->
        <div>
            <el-input
                    placeholder="ËæìÂÖ•ÂÖ≥ÈîÆÂ≠óËøõË°åËøáÊª§"
                    v-model="filterText">
            </el-input>
            <el-tree
                    ref="tree"
                    :data="treeData"
                    :props="treeProps"
                    node-key="id"
                    default-expand-all
                    draggable
                    :filter-node-method="filterNode"
                    @node-click="onTreeNodeClick"
                    @node-drop="onNodeDrop"
            >
              <span class="custom-tree-node" slot-scope="{ node, data }"
                    style="display: flex; justify-content: space-between; width: 100%;overflow: hidden; align-items: center;">
                <el-tooltip :content="data.label" placement="right" effect="light">
                    <span
                            @dblclick="editTreeLabel(node, data)"
                            style="cursor: pointer;
                         display: inline-block;
                         max-width: 160px;  /* Ê†πÊçÆÈúÄË¶ÅË∞ÉÊï¥ÂÆΩÂ∫¶ */
                         white-space: nowrap;
                         overflow: hidden;
                         text-overflow: ellipsis;"
                    >
                  <template v-if="!data.editing">{{ data.label }}</template>
                  <el-input v-else size="mini" v-model="data.label" @blur="finishEditLabel(data)"
                            @keyup.enter.native="finishEditLabel(data)"/>
                </span>
                </el-tooltip>
<!--                <span>-->
<!--                  <el-button v-if="Array.isArray(data.children)" type="text" size="mini" icon="el-icon-plus"-->
<!--                             @click.stop="addRecordToGroup(data)"></el-button>-->
<!--                    <el-button-->
<!--                            v-if="typeof data.recordIndex === 'number'"-->
<!--                            type="text"-->
<!--                            size="mini"-->
<!--                            icon="el-icon-copy-document"-->
<!--                            @click.stop="copyRecord(data)"-->
<!--                    ></el-button>-->
<!--                  <el-button type="text" size="mini" icon="el-icon-delete"-->
<!--                             @click.stop="deleteTreeNode(data)"></el-button>-->

<!--                </span>-->
                  <!-- Tree ËäÇÁÇπÂè≥‰æßÊìç‰ΩúÊåâÈíÆ -->
                <span>
                  <!-- ‚ûï ‰ªÖÁî®‰∫éÂàÜÁªÑ -->
                  <el-button
                          v-if="Array.isArray(data.children)"
                          type="text"
                          size="mini"
                          icon="el-icon-plus"
                          @click.stop="addRecordToGroup(data)">
                  </el-button>
                  <el-button
                          v-if="typeof data.recordIndex === 'number'"
                          type="text"
                          size="mini"
                          icon="el-icon-copy-document"
                          @click.stop="copyRecord(data)"
                  ></el-button>
                    <!-- üóëÔ∏è Âà†Èô§ÊåâÈíÆÂä†Á°ÆËÆ§ popper -->
                  <el-popconfirm
                          title="Á°ÆËÆ§Âà†Èô§Ê≠§È°πÔºü"
                          confirm-button-text="Âà†Èô§"
                          cancel-button-text="ÂèñÊ∂à"
                          icon="el-icon-warning"
                          icon-color="#f56c6c"
                          @confirm="deleteTreeNode(data)">
                    <el-button
                            slot="reference"
                            type="text"
                            size="mini"
                            icon="el-icon-delete"
                            @click.stop>
                    </el-button>
                  </el-popconfirm>
                </span>
              </span>
            </el-tree>
        </div>
    </div>

    <!-- Main Table -->
    <div class="main">
        <el-input v-model="currentRemark" placeholder="ËØ∑ËæìÂÖ•Êú¨Ê¨°ËÆ∞ÂΩïÂ§áÊ≥®" class="remark-input"
                  style="margin-bottom: 10px"></el-input>
        <el-button type="primary" size="mini" @click="columnDrawer = true">ÂàóËÆæÁΩÆ</el-button>
        <el-table height="80vh" :data="tableData" border style="width: 100%; margin-bottom: 10px" :key="tableKey">
            <el-table-column v-for="(col, index) in columns" :key="col._id" align="center" min-width="200"
                             :label="col.label"
                             :prop="col._id">
                <template slot-scope="scope">
                    <!-- ÊñáÊú¨Á±ªÂûã -->
                    <el-input v-if="col.type === 'text'" v-model="scope.row[col._id]" size="mini"></el-input>

                    <!-- Â§öË°åÊñáÊú¨Á±ªÂûã -->
                    <el-input type="textarea" v-else-if="col.type === 'textarea'" v-model="scope.row[col._id]"
                              size="mini"
                              :autosize="{ minRows: 1, maxRows: 10 }"></el-input>

                    <!-- ‰∏ãÊãâÈÄâÊã©Á±ªÂûã -->
                    <el-select v-else-if="col.type === 'select'" v-model="scope.row[col._id]" size="mini"
                               placeholder="ËØ∑ÈÄâÊã©"
                               style="width: 100%">
                        <el-option v-for="opt in col.options || []" :key="opt" :label="opt" :value="opt"></el-option>
                    </el-select>

                    <!-- Â§öÊ†áÁ≠æËæìÂÖ• -->
                    <div v-else-if="col.type === 'tag'"
                         style="display: flex; flex-wrap: wrap; gap: 5px; align-items: center;">
                        <el-tag v-for="(tag, idx) in (scope.row[col._id] || [])" :key="idx" closable
                                @close="scope.row[col._id].splice(idx, 1)" type="primary">
                            {{ tag }}
                        </el-tag>
                        <el-input v-model="tagInput[col._id + '_' + scope.$index]" size="mini" class="tag-input"
                                  placeholder="ËæìÂÖ•Ê†áÁ≠æÂêéÂõûËΩ¶"
                                  @keyup.enter.native.prevent="addTag(scope.row, col._id, scope.$index)"
                                  style="width: 120px;"></el-input>
                    </div>
                    <div v-else-if="col.type==='rate'">
                        <el-rate
                                v-model="scope.row[col._id]"
                                :max="5"
                                text-color="#ff9900"
                                show-score
                                allow-half
                                size="small"
                        />
                    </div>
                    <div v-else-if="col.type==='progress'"
                         style="width: 100%; align-items:center;">

                        <div style="width: 100%">
                            <el-progress :percentage="scope.row[col._id]" :color="customColors"></el-progress>
                        </div>
                        <div style="">
                            <el-input-number size="mini" v-model="scope.row[col._id]" :step="5"
                                             controls-position="right" :min="0" :max="100"></el-input-number>
                        </div>
                    </div>
<!--                     Â§öÈÄâÊ°ÜÁ±ªÂûã-->
                    <el-checkbox-group v-else-if="col.type === 'checkbox'" v-model="scope.row[col._id]" size="mini">
                        <el-checkbox style="margin-right: 10px" v-for="opt in col.options || []" :key="opt" :label="opt"
                                     border>{{ opt }}
                        </el-checkbox>
                    </el-checkbox-group>


                    <div v-else-if="col.type === 'date'" style="width: 100%">
                        <!-- date Á±ªÂûãÊ∏≤Êüì -->
                        <el-date-picker
                                style="width: 80%;"
                                size="mini"
                                v-model="scope.row[col._id]"
                                type="datetime"
                                placeholder="ÈÄâÊã©Êó•ÊúüÊó∂Èó¥"
                                align="right"
                                :picker-options="pickerOptions">
                        </el-date-picker>
                        <div>
                            {{formatDateTime(scope.row[col._id])}}
                        </div>
                    </div>
                    <!-- ÂÖúÂ∫ïÊñáÊú¨ËæìÂÖ• -->
                    <el-input v-else v-model="scope.row[col._id]" size="mini"></el-input>
                </template>
            </el-table-column>
            <el-table-column fixed="right" align="center" label="Êìç‰Ωú" width="80">
                <template slot-scope="scope">
                    <el-button :disabled="scope.$index === 0" icon="el-icon-top" size="mini" @click.stop="moveRow(scope.$index, 'up')" type="text"/>
                    <el-button :disabled="scope.$index === tableData.length - 1" icon="el-icon-bottom" size="mini" @click.stop="moveRow(scope.$index, 'down')" type="text"/>
                    <el-button icon="el-icon-delete" size="mini" @click="removeRow(scope.$index)" type="text"/>
                </template>
            </el-table-column>
        </el-table>

        <el-button type="primary" icon="el-icon-plus" @click="addRow" size="mini">Ê∑ªÂä†Ë°å</el-button>
        <el-button type="success" icon="el-icon-check" @click="saveRecord" size="mini">‰øùÂ≠ò</el-button>
    </div>

    <!-- Drawer: Column Settings -->
    <el-drawer title="ÂàóËÆæÁΩÆ" :visible.sync="columnDrawer" direction="rtl" size="30%">
        <div style="padding: 10px;">
            <el-form @submit.native.prevent>
                <el-form-item label="ÂàóÂêç">
                    <el-input v-model="newColumn.label" placeholder="Â¶ÇÔºöÁ≠âÁ∫ß"/>
                </el-form-item>
                <el-form-item label="Á±ªÂûã">
                    <el-select v-model="newColumn.type" placeholder="ËØ∑ÈÄâÊã©Á±ªÂûã">
                        <el-option label="ÊñáÊú¨" value="text"></el-option>
                        <el-option label="Â§öË°åÊñáÊú¨" value="textarea"></el-option>
                        <el-option label="‰∏ãÊãâÈÄâÊã©" value="select"></el-option>
                        <el-option label="Ê†áÁ≠æ" value="tag"></el-option>
                        <el-option label="Â§öÈÄâÊ°Ü" value="checkbox"></el-option>
                        <el-option label="ÊòüÁ∫ßËØÑÂàÜ" value="rate"></el-option>
                        <el-option label="ËøõÂ∫¶Êù°" value="progress"></el-option>
                        <el-option label="Êó•Êúü" value="date"></el-option>
                    </el-select>
                </el-form-item>
                <el-form-item v-if="newColumn.type === 'select'" label="ÈÄâÈ°πÔºàÈÄóÂè∑ÂàÜÈöîÔºâ">
                    <el-input v-model="newColumn.optionsText" placeholder="‰æãÂ¶ÇÔºöÁ∫¢,Áªø,Ëìù"/>
                </el-form-item>

                <el-button type="primary" @click="confirmAddColumn">Á°ÆËÆ§Ê∑ªÂä†</el-button>
            </el-form>

            <el-divider>ÂΩìÂâçÂàóÔºàÂèØÊãñÂä®ÊéíÂ∫èÔºâ</el-divider>
            <!-- ÊõøÊç¢ drawer ‰∏≠ columns ËÆæÁΩÆÁöÑÊØèÈ°πÂ±ïÁ§∫ÈÄªËæë -->
            <draggable v-model="columns" :options="{ handle: '.drag-handle' }" @end="updateTableKey">
                <div v-for="(col, i) in columns" :key="col._id"
                     style="margin-bottom: 5px; display: flex; flex-direction: column; gap: 4px;">

                    <!-- Êñ∞Â¢ûÁ±ªÂûãÊòæÁ§∫ -->
                    <div style="font-size: 12px; color: #909399; user-select: none;">
                        Á±ªÂûã: <strong>{{ typeLabel(col.type) }}</strong>
                    </div>
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <el-input v-model="col.label" size="mini" placeholder="ÂàóÂêç"
                                  @blur="validateAndUpdateColumn(i)"></el-input>
                        <el-button icon="el-icon-rank" type="text" class="drag-handle" size="mini"></el-button>
                        <el-button icon="el-icon-delete" @click="removeColumn(i)" type="text" size="mini"></el-button>
                    </div>
                    <div v-if="col.type === 'select' || col.type === 'checkbox'">
                        <el-input placeholder="ÈÄâÈ°πÔºàÈÄóÂè∑ÂàÜÈöîÔºâ" v-model="col.optionsText" size="mini"
                                  @input="updateSelectOptions(i, col.optionsText)"></el-input>
                    </div>
                </div>
            </draggable>
        </div>
    </el-drawer>
    <el-drawer
            :title="`AI ÂàÜÊûêÁªìÊûú, ÂΩìÂâçËÆ∞ÂΩï:${selectedRecord?.remark || ''}`"
            :visible.sync="drawerVisible"
            size="90%"
            direction="btt"
    >

        <div style="padding: 30px">
            <el-form size="mini" label-width="80px">
                <el-row>
                    <el-col :span="6">
                        <el-form-item label="AIÁ±ªÂûã">
                            <el-select v-model="ai.path" placeholder="ËØ∑ÈÄâÊã©Á±ªÂûã">
                                <el-option v-for="item in aiType" :label="item.name" :value="item.url"></el-option>
                            </el-select>
                        </el-form-item>
                    </el-col>
                    <el-col :span="6">

                       <el-form-item label="API-Key">
                           <el-input v-model="ai.key"></el-input>
                       </el-form-item>
                    </el-col>
                </el-row>
                <el-row>
                    <el-col :span="24">
                        <el-form-item label="ÂØπËØùÂÜÖÂÆπ">
                            <el-input placeholder="ËØ∑ËæìÂÖ•, Âê¶ÂàôÂè™‰ºöÂèëÈÄÅÂØπÂ∫îÊï∞ÊçÆÁªôDeepSeek;  ÊöÇ‰∏çÊîØÊåÅÂ§öËΩÆÂØπËØù" v-model="condition" type="textarea"></el-input>
                        </el-form-item>
                    </el-col>
                </el-row>
                <el-row>
                    <el-col :span="24">
                        <el-form-item>
                            </el-form-item>
                    </el-col>
                </el-row>
            </el-form>
            <el-button :disabled="aiLoading" v-loading="aiLoading" element-loading-text="AIËæìÂá∫‰∏≠" element-loading-spinner="el-icon-loading" style="margin-left: 30px" type="default" size="mini" @click="analyzeData" size="mini">ÂºÄÂßãÂàÜÊûê</el-button>
            <div class="markdown-body" v-html="renderedMarkdown" style="margin: 30px; padding: 10px; overflow-y: scroll; height: 50vh;border: #909399 1px solid;border-radius: 10px"></div>

        </div>

    </el-drawer>
</div>

<!-- Vue Script -->
<script>
    Vue.component("draggable", vuedraggable);

    new Vue({
        el: "#app",
        data() {
            return {
                groupedHistory: [],
                currentRecordIndex: null,
                selectedRecord: null,
                aiLoading: false,
                aiResult: '',
                filterText: '',
                condition: '',
                treeData: [],
                aiType: [
                    {
                        name: 'DeepSeek',
                        url: 'https://api.deepseek.com/chat/completions'
                    }
                ],
                ai: {
                  path: '',
                  key: ''
                },
                treeProps: {children: 'children', label: 'label'},
                selectedGroupId: null,
                columns: [],
                apiKey: '',
                newColumn: {
                    label: "",
                    type: "text",
                    optionsText: ""
                },
                pickerOptions: {
                    shortcuts: [{
                        text: '‰ªäÂ§©',
                        onClick(picker) {
                            picker.$emit('pick', new Date());
                        }
                    }, {
                        text: 'Êò®Â§©',
                        onClick(picker) {
                            const date = new Date();
                            date.setTime(date.getTime() - 3600 * 1000 * 24);
                            picker.$emit('pick', date);
                        }
                    }, {
                        text: '‰∏ÄÂë®Ââç',
                        onClick(picker) {
                            const date = new Date();
                            date.setTime(date.getTime() - 3600 * 1000 * 24 * 7);
                            picker.$emit('pick', date);
                        }
                    }]
                },
                customColors: [
                    {color: '#f56c6c', percentage: 20},
                    {color: '#e6a23c', percentage: 40},
                    {color: '#5cb87a', percentage: 60},
                    {color: '#1989fa', percentage: 80},
                    {color: '#6f7ad3', percentage: 100}
                ],
                columnDrawer: false,
                drawerVisible: false,
                tableData: [],
                history: [],
                currentIndex: null,
                currentRemark: "",
                storageKey: "dnf_material_history_v3",
                tagInput: {},
                progress: 0,
                tableKey: Date.now()
            };
        },
        computed: {
            renderedMarkdown() {
                console.log(window)
                return window.marked.marked(this.aiResult || '');
            }
        },
        watch: {
            filterText(val) {
                this.$refs.tree.filter(val);
            }
        },
        created() {
            this.loadHistoryFromStorage();
        },
        methods: {
            onNodeDrop(draggingNode, dropNode, dropType, ev) {
                const dragData = draggingNode.data;
                const dropData = dropNode.data;

                // Âè™Â§ÑÁêÜËÆ∞ÂΩïËäÇÁÇπÊãñÂä®Âà∞ÂàÜÁªÑËäÇÁÇπ
                if (typeof dragData.recordIndex === 'number' && dropData.children) {
                    const fromGroup = this.groupedHistory.find(g => g.id === dragData.groupId);
                    const toGroup = this.groupedHistory.find(g => g.id === dropData.id);
                    if (!fromGroup || !toGroup) return;

                    // ÂèñÂá∫ÊãñÊãΩËÆ∞ÂΩï
                    const record = fromGroup.children.splice(dragData.recordIndex, 1)[0];
                    // ÊèíÂÖ•ÁõÆÊ†áÂàÜÁªÑÊú´Â∞æ
                    toGroup.children.push(record);

                    this.saveHistoryToStorage();
                    this.buildTree();
                    this.$message.success("ËÆ∞ÂΩïÂ∑≤ÁßªÂä®");
                } else {
                    this.$message.warning("Âè™ÂÖÅËÆ∏ÁßªÂä®ËÆ∞ÂΩïÂà∞ÂàÜÁªÑ");
                }
            },
            copyRecord(data) {
                const group = this.groupedHistory.find(g => g.id === data.groupId);
                if (!group) return;

                const record = group.children[data.recordIndex];
                if (!record) return;

                // Ê∑±Êã∑Ë¥ùËÆ∞ÂΩï
                const newRecord = JSON.parse(JSON.stringify(record));

                // ÊèíÂÖ•Âà∞Âêå‰∏Ä‰∏™ÂàÜÁªÑÊú´Â∞æ
                group.children.push(newRecord);
                newRecord.remark = newRecord.remark?.split("#")[0] + '#' + this.getRandomValues()
                this.saveHistoryToStorage();
                this.buildTree();
                this.$message.success("ËÆ∞ÂΩïÂ∑≤Â§çÂà∂");
            },
            filterNode(value, data) {
                if (!value) return true;
                return data.label.indexOf(value) !== -1;
            },
            createGroup() {
                const id = 'group_' + Date.now();
                this.groupedHistory.push({id, name: 'Êñ∞ÂàÜÁªÑ', children: []});
                this.saveHistoryToStorage();
                this.buildTree();
            },
            addRecordToGroup(group) {
                this.columns = [];
                this.tableData = [];
                this.currentRemark = '';
                this.selectedGroupId = group.id;
                this.currentRecordIndex = null;  // Êñ∞Â¢ûÔºåÊ†áÊòéÊòØÊñ∞Â¢ûËÆ∞ÂΩï
            },
            saveRecord() {
                if (!this.selectedGroupId) {
                    this.$message.error("ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ÂàÜÁªÑ");
                    return;
                }

                debugger
                const group = this.groupedHistory.find(g => g.id === this.selectedGroupId);
                if (!group) return;

                const newRecord = {
                    remark: this.currentRemark,
                    columns: JSON.parse(JSON.stringify(this.columns)),
                    data: JSON.parse(JSON.stringify(this.tableData))
                };

                if (typeof this.currentRecordIndex === 'number') {
                    // ‚úÖ Êõ¥Êñ∞Â∑≤ÊúâËÆ∞ÂΩï
                    this.$set(group.children, this.currentRecordIndex, newRecord);
                    this.$message.success("ËÆ∞ÂΩïÂ∑≤Êõ¥Êñ∞");
                } else {
                    // ‚úÖ Êñ∞Â¢ûËÆ∞ÂΩï
                    group.children.push(newRecord);
                    this.$message.success("ËÆ∞ÂΩïÂ∑≤‰øùÂ≠òÂà∞ÂàÜÁªÑ");
                }

                this.saveHistoryToStorage();
                this.buildTree();
            },
            addColumn() {
                const id = 'col_' + Date.now();
                const label = prompt("ËØ∑ËæìÂÖ•ÂàóÂêç", "Âàó");
                if (!label) return;
                this.columns.push({id, label});
                this.tableData.forEach(row => this.$set(row, id, ''));
            },
            addRow() {
                // const row = {};
                // this.columns.forEach(c => row[c.id] = '');
                this.tableData.push(this.emptyRow());
                // this.emptyRow()
            },
            buildTree() {
                this.treeData = this.groupedHistory.map(group => ({
                    id: group.id,
                    label: group.name,
                    editing: false,
                    children: group.children.map((rec, idx) => ({
                        id: group.id + '_rec_' + idx,
                        label: `[${idx + 1}] ${rec.remark || 'Êú™ÂëΩÂêç'}`,
                        groupId: group.id,
                        recordIndex: idx
                    }))
                }));
            },
            onTreeNodeClick(data) {
                if (typeof data.recordIndex === 'number') {
                    const group = this.groupedHistory.find(g => g.id === data.groupId);
                    const record = group?.children[data.recordIndex];
                    if (!record) return;
                    this.columns = JSON.parse(JSON.stringify(record.columns));
                    this.tableData = JSON.parse(JSON.stringify(record.data));
                    this.currentRemark = record.remark;
                    this.selectedGroupId = group.id;
                    this.currentRecordIndex = data.recordIndex; // ËÆæÁΩÆÂΩìÂâçÊ≠£Âú®ÁºñËæëÁöÑËÆ∞ÂΩïÁ¥¢Âºï
                    this.selectedRecord = record; // ‚úÖ Êñ∞Â¢ûËøôÂè•
                } else {
                    // this.selectedGroupId = data.id;
                    // this.currentRecordIndex = null; // ‰∏çÊòØËÆ∞ÂΩïÔºåÂè™ÊòØÁÇπÂáª‰∫ÜÂàÜÁªÑ
                }
            },
            deleteTreeNode(data) {
                if (typeof data.recordIndex === 'number') {
                    const group = this.groupedHistory.find(g => g.id === data.groupId);
                    group?.children.splice(data.recordIndex, 1);
                } else {
                    this.groupedHistory = this.groupedHistory.filter(g => g.id !== data.id);
                }
                this.saveHistoryToStorage();
                this.buildTree();
            },
            editTreeLabel(node, data) {
                if (!data.children) {
                    return
                }
                this.$set(data, 'editing', true);
            },
            finishEditLabel(data) {
                data.editing = false;
                const group = this.groupedHistory.find(g => g.id === data.id);
                if (group) group.name = data.label;
                this.saveHistoryToStorage();
            },
            saveHistoryToStorage() {
                localStorage.setItem(this.storageKey, JSON.stringify(this.groupedHistory));
            },
            loadHistoryFromStorage() {
                try {
                    this.groupedHistory = JSON.parse(localStorage.getItem(this.storageKey) || '[]');
                    this.buildTree();
                } catch {
                    this.groupedHistory = [];
                }
            },
            typeLabel(type) {
                const map = {
                    text: "ÊñáÊú¨",
                    textarea: "Â§öË°åÊñáÊú¨",
                    select: "‰∏ãÊãâÈÄâÊã©",
                    tag: "Ê†áÁ≠æ",
                    progress: "ËøõÂ∫¶Êù°",
                    rate: "ÊòüÁ∫ßËØÑÂàÜ",
                    date: "Êó•ÊúüÊó∂Èó¥",
                    checkbox: "Â§öÈÄâÊ°Ü"
                };
                return map[type] || "Êú™Áü•Á±ªÂûã";
            },
            updateTableKey() {
                this.tableKey = Date.now(); // ÊØèÊ¨°ËÆæÁΩÆ‰∏Ä‰∏™‰∏çÂêåÁöÑ key ÂÄºËß¶ÂèëÈáçÊñ∞Ê∏≤Êüì
            },
            addTag(row, colId, rowIndex) {
                const key = colId + "_" + rowIndex;
                let val = this.tagInput[key];
                if (!val) return;
                val = val.trim();
                if (!val) return;

                if (!Array.isArray(row[colId])) {
                    this.$set(row, colId, []);
                }
                if (!row[colId].includes(val)) {
                    row[colId].push(val);
                }
                this.$set(this.tagInput, key, "");
            },
            generateColId() {
                return 'col_' + this.getRandomValues();
            },
            getRandomValues() {
                return Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 8)
            },
            newRecord() {
                this.columns.splice(0);
                this.tableData.splice(0);
                this.currentIndex = null;
                this.currentRemark = "";
                this.tagInput = {};
            },
            moveRow(index, direction) {
                const data = [...this.tableData]; // Êñ∞Êï∞ÁªÑÊõøÊç¢ÂºïÁî®

                if (direction === 'up' && index > 0) {
                    [data[index - 1], data[index]] = [data[index], data[index - 1]];
                } else if (direction === 'down' && index < data.length - 1) {
                    [data[index], data[index + 1]] = [data[index + 1], data[index]];
                }

                this.tableData = data; // ÊõøÊç¢ÂºïÁî®Ëß¶ÂèëËßÜÂõæÊõ¥Êñ∞
            },
            removeRow(index) {
                this.tableData.splice(index, 1);
                Object.keys(this.tagInput).forEach(key => {
                    if (key.endsWith('_' + index)) {
                        delete this.tagInput[key];
                    }
                });
            },
            confirmAddColumn() {
                const label = this.newColumn.label.trim();
                if (!label) return;
                if (this.columns.find((c) => c.label === label)) {
                    this.$message.error("ÂàóÂêç‰∏çËÉΩÈáçÂ§ç");
                    return;
                }
                const id = this.generateColId();
                const type = this.newColumn.type || "text";
                const column = {
                    label,
                    type,
                    _id: id
                };
                if (type === "select" || type === "checkbox") {
                    column.options = this.newColumn.optionsText.split(",").map((s) => s.trim()).filter((s) => s);
                    column.optionsText = this.newColumn.optionsText;
                }
                this.columns.push(column);

                this.tableData.forEach(row => {
                    if (column.type === 'tag' || column.type === 'checkbox') {
                        this.$set(row, id, []);
                    } else if (column.type === 'rate' || column.type === 'progress') {
                        this.$set(row, id, 0);
                    } else {
                        this.$set(row, id, "");
                    }
                });

                this.newColumn = {
                    label: "",
                    type: "text",
                    optionsText: ""
                };
            },
            removeColumn(index) {
                const col = this.columns[index];
                this.columns.splice(index, 1);
                this.tableData.forEach((row) => {
                    this.$delete(row, col._id);
                });
            },
            emptyRow() {
                const row = {};
                this.columns.forEach((col) => {
                    if (col.type === 'tag' || col.type === 'checkbox') {
                        row[col._id] = [];
                    } else if (col.type === 'select') {
                        row[col._id] = ""; // ‰∏ãÊãâÈªòËÆ§Á©∫Â≠óÁ¨¶‰∏≤
                    } else if (col.type === 'rate' || col.type === 'progress') {
                        row[col._id] = 0;
                    } else {
                        row[col._id] = ""; // ÂÖ∂‰ªñÁ±ªÂûãÈªòËÆ§Á©∫Â≠óÁ¨¶‰∏≤
                    }


                });
                return row;
            },

            syncOptionsTextToColumns() {
                this.columns.forEach(col => {
                    if (col.type === 'select' || col.type === 'checkbox') {
                        col.optionsText = (col.options || []).join(',');
                    }
                });
            },

            formatDateTime(isoString) {
                if (!isoString) {
                    return "";
                }
                const date = new Date(isoString)

                const pad = n => n.toString().padStart(2, '0')

                const year = date.getFullYear()
                const month = pad(date.getMonth() + 1)
                const day = pad(date.getDate())
                const hours = pad(date.getHours())
                const minutes = pad(date.getMinutes())
                const seconds = pad(date.getSeconds())

                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`
            },
            clearHistory() {
                this.$confirm(
                    'Ê≠§Êìç‰ΩúÂ∞ÜÊ∏ÖÁ©∫ÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩïÔºå‰∏îÊó†Ê≥ïÊÅ¢Â§ç„ÄÇËØ∑Á°ÆËÆ§ÊòØÂê¶Â∑≤ÂÆåÊàêÊï∞ÊçÆÂ§á‰ªΩÔºü',
                    'Ë≠¶Âëä',
                    {
                        confirmButtonText: 'ÊàëÂ∑≤Â§á‰ªΩÔºåÊ∏ÖÁ©∫',
                        cancelButtonText: 'ÂèñÊ∂à',
                        type: 'warning'
                    }
                ).then(() => {
                    this.groupedHistory = [];
                    this.treeData = [];
                    this.columns = [];
                    this.tableData = [];
                    this.currentRemark = '';
                    this.selectedGroupId = null;
                    this.saveHistoryToStorage();
                    this.$message.success('ÂéÜÂè≤ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫');
                }).catch(() => {
                    this.$message.info('Â∑≤ÂèñÊ∂àÊ∏ÖÈô§');
                });
            },
            exportData() {
                const dataStr = JSON.stringify(this.groupedHistory, null, 2);
                const blob = new Blob([dataStr], {
                    type: "application/json"
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `diy_record_data_backup_${this.formatDateTime(new Date().getTime())}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },
            importData(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (!Array.isArray(imported)) {
                            this.$message.error("ÂØºÂÖ•ÁöÑÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°Æ");
                            return;
                        }

                        this.groupedHistory = imported;
                        this.saveHistoryToStorage();
                        this.buildTree();
                        this.$message.success("ÂØºÂÖ•ÊàêÂäü");

                    } catch (err) {
                        this.$message.error("ÂØºÂÖ•Â§±Ë¥•ÔºåÊñá‰ª∂ÂèØËÉΩ‰∏çÊòØÊúâÊïàÁöÑ JSON");
                    }
                };
                reader.readAsText(file);
                // Ê∏ÖÁ©∫ input ÁöÑÂÄºÔºåÈÅøÂÖçÈáçÂ§çÂØºÂÖ•Âêå‰∏Ä‰∏™Êñá‰ª∂‰∏ç‰ºöËß¶Âèë change ‰∫ã‰ª∂
                e.target.value = null;
            },
            // summarize(data) {
            //     if (!data || !data.length) return "";
            //     const firstRow = data[0];
            //     if (!firstRow) return "";
            //     const firstKey = Object.keys(firstRow)[0];
            //     if (!firstKey) return "";
            //     return firstRow[firstKey];
            // },
            // handleTagEnter(row, colId, rowIndex) {
            //     const key = colId + "_" + rowIndex;
            //     let val = this.tagInput[key];
            //     if (!val) return;
            //     val = val.trim();
            //     if (!val) return;
            //     this.$set(row, colId, val);
            //     this.$set(this.tagInput, key, "");
            // },
            validateAndUpdateColumn(index) {
                const col = this.columns[index];
                if (!col.label.trim()) {
                    this.$message.error("ÂàóÂêç‰∏çËÉΩ‰∏∫Á©∫");
                    col.label = "Êú™ÂëΩÂêçÂàó";
                }
                const duplicates = this.columns.filter((c, i) => c.label === col.label && i !== index);
                if (duplicates.length) {
                    this.$message.error("ÂàóÂêç‰∏çËÉΩÈáçÂ§ç");
                    col.label = col.label + "(ÈáçÂ§ç)";
                }
            },
            updateSelectOptions(index, optionsText) {
                this.columns[index].options = optionsText.replace("Ôºå", ",").split(",").map(s => s.trim()).filter(s => s);
            },
            async analyzeData0() {
                if (!this.selectedRecord) {
                    this.$message.warning("ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÆ∞ÂΩï");
                    return;
                }

                const { columns, data } = this.selectedRecord;

                const rows = data.map((row, i) => {
                    const rowStr = columns.map(col => `${col.label}: ${row[col._id]}`).join(', ');
                    return `Á¨¨ ${i + 1} Ë°åÔºö${rowStr}`;
                }).join('\n');

                const prompt = `ËØ∑ÂØπ‰ª•‰∏ãËÆ∞ÂΩïÊï∞ÊçÆËøõË°åÂàÜÊûêÔºåÂπ∂ÁªôÂá∫Ë∂ãÂäøÂíåÂª∫ËÆÆÔºö\n${rows}`;

                try {
                    const res = await axios.post('https://api.deepseek.com/chat/completions', {
                        model: 'deepseek-chat',
                        messages: [
                            { role: 'user', content: prompt }
                        ]
                    }, {
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${this.ai.key}`
                        }
                    });

                    const reply = res.data.choices?.[0]?.message?.content;
                    this.aiResult = reply || "Êó†ÂÜÖÂÆπËøîÂõû";
                } catch (err) {
                    console.error(err);
                    this.$message.error("AI ÂàÜÊûêÂ§±Ë¥•");
                }
            },
            async analyzeData() {
                if (!this.selectedRecord) {
                    this.$message.warning("ËØ∑ÂÖàÈÄâÊã©‰∏Ä‰∏™ËÆ∞ÂΩï");
                    return;
                }
                this.aiLoading = true;

                const { columns, data } = this.selectedRecord;
                const rows = data.map((row, i) => {
                    const rowStr = columns.map(col => `${col.label}: ${row[col._id]}`).join(', ');
                    return `Á¨¨ ${i + 1} Ë°åÔºö${rowStr}`;
                }).join('\n');

                const prompt = `ËØ∑ÂØπ‰ª•‰∏ãËÆ∞ÂΩïÊï∞ÊçÆËøõË°åÂàÜÊûêÔºö\n${rows}`;

                this.aiResult = "ÂàÜÊûê‰∏≠ÔºåËØ∑Á®çÂÄô...\n"; // Ê∏ÖÁ©∫ÊóßÂÜÖÂÆπ
                try {
                    const res = await fetch(this.ai.path, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${this.ai.key}`,
                            "Accept": "text/event-stream"
                        },
                        body: JSON.stringify({
                            model: "deepseek-chat",
                            stream: true,
                            messages: [{ role: "user", content: prompt },
                                { role: "user", content: this.condition }]
                        })
                    });

                    const reader = res.body.getReader();
                    const decoder = new TextDecoder("utf-8");
                    let partial = "";
                    this.aiResult = ''
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) {
                            this.aiLoading = false
                            break;
                        }

                        const chunk = decoder.decode(value, { stream: true });
                        partial += chunk;

                        // Ëß£Êûê SSE ‰∫ã‰ª∂
                        const lines = partial.split('\n');
                        partial = lines.pop(); // incomplete line cache

                        for (let line of lines) {
                            if (line.startsWith("data: ")) {
                                const payload = line.slice(6).trim();
                                if (payload === "[DONE]") break;

                                const json = JSON.parse(payload);
                                const delta = json.choices?.[0]?.delta?.content;
                                if (delta) {
                                    this.aiResult += delta; // Â¢ûÈáèËøΩÂä†
                                }
                            }
                        }
                    }
                } catch (err) {
                    console.error(err);
                    this.aiLoading = false
                    this.$message.error("AIÊµÅÂºèÂàÜÊûêÂ§±Ë¥•");
                }
            }
        }
    });
</script>
</body>
</html>
